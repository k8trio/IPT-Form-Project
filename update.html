<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update CV</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Update Your CV</h1>
            <a href="#" onclick="goBack()" class="back-btn">Back to View</a>
        </header>

        <form id="cvForm" class="cv-form">
            <div class="color-selector">
                <h3>Choose Your CV Theme</h3>
                <div class="color-options">
                    <label class="color-option">
                        <input type="radio" name="color_theme" value="#1a3a52">
                        <span class="color-preview" style="background: #1a3a52;"></span>
                        <span class="color-name">Navy Blue</span>
                    </label>
                    <label class="color-option">
                        <input type="radio" name="color_theme" value="#2d4a3e">
                        <span class="color-preview" style="background: #2d4a3e;"></span>
                        <span class="color-name">Forest Green</span>
                    </label>
                    <label class="color-option">
                        <input type="radio" name="color_theme" value="#3d3d3d">
                        <span class="color-preview" style="background: #3d3d3d;"></span>
                        <span class="color-name">Charcoal Grey</span>
                    </label>
                </div>
            </div>

            <div class="form-section">
                <h2>Personal Information</h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Profile Photo</label>
                        <div id="currentImagePreview"></div>
                        <input type="file" id="profileImage" accept="image/*" class="file-input">
                        <div id="imagePreview"></div>
                    </div>
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="website" placeholder="https://">
                    </div>
                    <div class="form-group full-width">
                        <label>Address</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group full-width">
                        <label>About Me</label>
                        <textarea id="aboutMe" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Education</h2>
                <div id="educationContainer"></div>
                <button type="button" class="add-more-btn" onclick="addEducation()">Add More Education</button>
            </div>

            <div class="form-section">
                <h2>Work Experience</h2>
                <div id="experienceContainer"></div>
                <button type="button" class="add-more-btn" onclick="addExperience()">Add More Experience</button>
            </div>

            <div class="form-section">
                <h2>Skills</h2>
                <div id="skillsContainer"></div>
                <button type="button" class="add-more-btn" onclick="addSkill()">Add More Skills</button>
            </div>

            <div class="form-actions">
                <button type="submit" class="save-btn">Save Changes</button>
            </div>
        </form>
    </div>

    <script>
        let currentCV = null;
        let currentId = null;
        let imageData = '';

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentId = parseInt(urlParams.get('id'));
            
            const cvList = JSON.parse(localStorage.getItem('cvList') || '[]');
            currentCV = cvList.find(cv => cv.id === currentId);
            
            if (!currentCV) {
                alert('CV not found!');
                window.location.href = 'index.html';
                return;
            }
            
            loadCVData(currentCV);
        };

        function loadCVData(cv) {
            document.getElementById('fullName').value = cv.fullName || '';
            document.getElementById('email').value = cv.email || '';
            document.getElementById('phone').value = cv.phone || '';
            document.getElementById('website').value = cv.website || '';
            document.getElementById('address').value = cv.address || '';
            document.getElementById('aboutMe').value = cv.aboutMe || '';
            
            const colorRadios = document.querySelectorAll('input[name="color_theme"]');
            colorRadios.forEach(radio => {
                if (radio.value === cv.colorTheme) {
                    radio.checked = true;
                }
            });
            
            if (cv.profileImage) {
                imageData = cv.profileImage;
                document.getElementById('currentImagePreview').innerHTML = 
                    '<p style="color: #718096; font-size: 14px; margin-bottom: 5px;">Current photo:</p><img src="' + cv.profileImage + '" style="max-width: 150px; border-radius: 8px;">';
            }
            
            const educationContainer = document.getElementById('educationContainer');
            educationContainer.innerHTML = '';
            if (cv.education && cv.education.length > 0) {
                cv.education.forEach(edu => {
                    const entry = createEducationEntry(edu);
                    educationContainer.appendChild(entry);
                });
            } else {
                educationContainer.appendChild(createEducationEntry());
            }
            
            const experienceContainer = document.getElementById('experienceContainer');
            experienceContainer.innerHTML = '';
            if (cv.experience && cv.experience.length > 0) {
                cv.experience.forEach(exp => {
                    const entry = createExperienceEntry(exp);
                    experienceContainer.appendChild(entry);
                });
            } else {
                experienceContainer.appendChild(createExperienceEntry());
            }
            
            const skillsContainer = document.getElementById('skillsContainer');
            skillsContainer.innerHTML = '';
            if (cv.skills && cv.skills.length > 0) {
                cv.skills.forEach(skill => {
                    const entry = createSkillEntry(skill);
                    skillsContainer.appendChild(entry);
                });
            } else {
                skillsContainer.appendChild(createSkillEntry());
            }
        }

        document.getElementById('profileImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    imageData = event.target.result;
                    document.getElementById('imagePreview').innerHTML = 
                        '<p style="color: #718096; font-size: 14px; margin-bottom: 5px;">New photo:</p><img src="' + imageData + '" style="max-width: 150px; border-radius: 8px;">';
                };
                reader.readAsDataURL(file);
            }
        });

        function createEducationEntry(data = {}) {
            const entry = document.createElement('div');
            entry.className = 'dynamic-entry';
            entry.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Degree</label>
                        <input type="text" class="degree" value="${data.degree || ''}">
                    </div>
                    <div class="form-group">
                        <label>Institution</label>
                        <input type="text" class="institution" value="${data.institution || ''}">
                    </div>
                    <div class="form-group">
                        <label>Start Year</label>
                        <input type="text" class="edu_start_year" value="${data.startYear || ''}">
                    </div>
                    <div class="form-group">
                        <label>End Year</label>
                        <input type="text" class="edu_end_year" value="${data.endYear || ''}">
                    </div>
                </div>
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            return entry;
        }

        function createExperienceEntry(data = {}) {
            const entry = document.createElement('div');
            entry.className = 'dynamic-entry';
            entry.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" class="job_title" value="${data.jobTitle || ''}">
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" class="company" value="${data.company || ''}">
                    </div>
                    <div class="form-group">
                        <label>Start Year</label>
                        <input type="text" class="exp_start_year" value="${data.startYear || ''}">
                    </div>
                    <div class="form-group">
                        <label>End Year</label>
                        <input type="text" class="exp_end_year" value="${data.endYear || ''}">
                    </div>
                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea class="description" rows="3">${data.description || ''}</textarea>
                    </div>
                </div>
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            return entry;
        }

        function createSkillEntry(data = {}) {
            const entry = document.createElement('div');
            entry.className = 'dynamic-entry skill-entry';
            entry.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Skill Name</label>
                        <input type="text" class="skill_name" value="${data.skillName || ''}">
                    </div>
                    <div class="form-group">
                        <label>Proficiency Level (1-7)</label>
                        <input type="number" class="skill_level" min="1" max="7" value="${data.skillLevel || 5}">
                    </div>
                </div>
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
            `;
            return entry;
        }

        function addEducation() {
            const container = document.getElementById('educationContainer');
            container.appendChild(createEducationEntry());
        }

        function addExperience() {
            const container = document.getElementById('experienceContainer');
            container.appendChild(createExperienceEntry());
        }

        function addSkill() {
            const container = document.getElementById('skillsContainer');
            container.appendChild(createSkillEntry());
        }

        document.getElementById('cvForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const updatedData = {
                id: currentId,
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                website: document.getElementById('website').value,
                address: document.getElementById('address').value,
                aboutMe: document.getElementById('aboutMe').value,
                colorTheme: document.querySelector('input[name="color_theme"]:checked').value,
                profileImage: imageData || currentCV.profileImage || '',
                education: [],
                experience: [],
                skills: []
            };

            document.querySelectorAll('#educationContainer .dynamic-entry').forEach(entry => {
                const degree = entry.querySelector('.degree').value;
                const institution = entry.querySelector('.institution').value;
                const startYear = entry.querySelector('.edu_start_year').value;
                const endYear = entry.querySelector('.edu_end_year').value;
                
                if (degree || institution) {
                    updatedData.education.push({ degree, institution, startYear, endYear });
                }
            });

            document.querySelectorAll('#experienceContainer .dynamic-entry').forEach(entry => {
                const jobTitle = entry.querySelector('.job_title').value;
                const company = entry.querySelector('.company').value;
                const startYear = entry.querySelector('.exp_start_year').value;
                const endYear = entry.querySelector('.exp_end_year').value;
                const description = entry.querySelector('.description').value;
                
                if (jobTitle || company) {
                    updatedData.experience.push({ jobTitle, company, startYear, endYear, description });
                }
            });

            document.querySelectorAll('#skillsContainer .dynamic-entry').forEach(entry => {
                const skillName = entry.querySelector('.skill_name').value;
                const skillLevel = entry.querySelector('.skill_level').value;
                
                if (skillName) {
                    updatedData.skills.push({ skillName, skillLevel });
                }
            });

            let cvList = JSON.parse(localStorage.getItem('cvList') || '[]');
            const index = cvList.findIndex(cv => cv.id === currentId);
            
            if (index !== -1) {
                cvList[index] = updatedData;
                localStorage.setItem('cvList', JSON.stringify(cvList));
                alert('CV updated successfully!');
                window.location.href = `view.html?id=${currentId}`;
            } else {
                alert('Error updating CV!');
            }
        });

        function goBack() {
            window.location.href = `view.html?id=${currentId}`;
        }
    </script>
</body>
</html>
